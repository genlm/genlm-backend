name: Codebase tests

on:
  pull_request:
  push:
    branches:
      - main

  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ONE-TIME: print disk usage info to diagnose what's filling the runner
      - name: Full disk usage diagnosis (one-time)
        run: |
          set -euxo pipefail

          echo "===== DISK SUMMARY ====="
          df -h

          echo
          echo "===== INODE USAGE ====="
          df -ih

          echo
          echo "===== TOP-LEVEL USAGE: / ====="
          sudo du -xh / --max-depth=1 | sort -hr

          echo
          echo "===== /home USAGE ====="
          du -xh /home --max-depth=2 | sort -hr

          echo
          echo "===== WORKSPACE USAGE ====="
          du -xh "$GITHUB_WORKSPACE" --max-depth=3 | sort -hr || true

          echo
          echo "===== COMMON CACHE DIRS ====="
          for d in \
            ~/.cache \
            ~/.cache/pip \
            ~/.cache/torch \
            ~/.cache/huggingface \
            ~/.npm \
            ~/.conda \
            ~/.local \
            /usr/local \
            /usr/share \
            /opt \
            "$AGENT_TOOLSDIRECTORY" \
            /var/lib/docker \
          ; do
            if [ -d "$d" ]; then
              echo "--- $d ---"
              du -sh "$d"
            fi
          done

          echo
          echo "===== LARGE FILES (>500MB) ====="
          sudo find / -type f -size +500M -exec ls -lh {} \; 2>/dev/null | sort -k5 -hr | head -n 50

          echo
          echo "===== DONE ====="

      - name: Targeted runner storage diagnosis (add-on)
        run: |
          set -euxo pipefail
      
          echo "===== FILESYSTEM FOR FAILING PATH ====="
          df -hT /home/runner/actions-runner/cached || true
          df -ih /home/runner/actions-runner/cached || true
      
          echo
          echo "===== SIZE OF RUNNER CACHE + DIAG ====="
          sudo du -sh /home/runner/actions-runner/cached || true
          sudo du -sh /home/runner/actions-runner/cached/_diag || true
          sudo du -xh /home/runner/actions-runner/cached --max-depth=2 2>/dev/null | sort -hr | head -n 80 || true
      
          echo
          echo "===== BIGGEST DIAG LOGS ====="
          sudo ls -lhS /home/runner/actions-runner/cached/_diag 2>/dev/null | head -n 50 || true
      
          echo
          echo "===== BIGGEST FILES UNDER RUNNER CACHE (top 50) ====="
          sudo find /home/runner/actions-runner/cached -type f -printf "%s\t%p\n" 2>/dev/null \
            | sort -nr | head -n 50 \
            | awk '{printf "%.2f MB\t%s\n", $1/1024/1024, $2}' || true
      

      - uses: actions/setup-python@v4
        with:
          python-version: 3.11.5
          cache: 'pip'

      - name: Run Tests
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -e .[test]
          pip install -r requirements-dev.txt
          python -m pytest tests --ignore=tests/test_mlx.py
