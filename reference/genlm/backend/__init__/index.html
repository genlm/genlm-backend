
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../../..">
      
      
        <link rel="next" href="../cache/">
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>backend - GenLM Backend</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#genlm.backend" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="GenLM Backend" class="md-header__button md-logo" aria-label="GenLM Backend" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GenLM Backend
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              backend
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/probcomp/genlm-backend" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="GenLM Backend" class="md-nav__button md-logo" aria-label="GenLM Backend" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    GenLM Backend
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/probcomp/genlm-backend" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Code Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Code Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    genlm
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    genlm
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  
  <span class="md-ellipsis">
    
  
    backend
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link md-nav__link--active" for="__nav_2_1_1" id="__nav_2_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    backend
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    cache
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../llm/__init__/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    llm
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_1_2" id="__nav_2_1_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    llm
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm/hf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    hf
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm/mlx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    mlx
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm/vllm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    vllm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../tokenization/__init__/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    tokenization
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_1_3" id="__nav_2_1_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    tokenization
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tokenization/bytes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    bytes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tokenization/vocab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    vocab
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../trie/__init__/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    trie
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_1_4" id="__nav_2_1_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    trie
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trie/async_impl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    async_impl
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trie/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    base
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trie/parallel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    parallel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#genlm.backend" class="md-nav__link">
    <span class="md-ellipsis">
      
        backend
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#genlm.backend.AsyncVirtualLM" class="md-nav__link">
    <span class="md-ellipsis">
      
        AsyncVirtualLM
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AsyncVirtualLM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncVirtualLM.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncVirtualLM.from_name" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_name
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncVirtualLM.next_token_logprobs" class="md-nav__link">
    <span class="md-ellipsis">
      
        next_token_logprobs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncVirtualLM.next_token_logprobs_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        next_token_logprobs_sync
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncVirtualLM.batch_next_token_logprobs_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        batch_next_token_logprobs_sync
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncVirtualLM.clear_cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        clear_cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncVirtualLM.__del__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __del__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncVirtualLM.sample" class="md-nav__link">
    <span class="md-ellipsis">
      
        sample
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer" class="md-nav__link">
    <span class="md-ellipsis">
      
        AsyncTransformer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AsyncTransformer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.from_name" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_name
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.clear_cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        clear_cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.clear_kv_cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        clear_kv_cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.reset_async_queries" class="md-nav__link">
    <span class="md-ellipsis">
      
        reset_async_queries
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.cache_kv" class="md-nav__link">
    <span class="md-ellipsis">
      
        cache_kv
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.batch_evaluate_queries" class="md-nav__link">
    <span class="md-ellipsis">
      
        batch_evaluate_queries
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.add_query" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_query
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.walk_cache" class="md-nav__link">
    <span class="md-ellipsis">
      
        walk_cache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.next_token_logprobs" class="md-nav__link">
    <span class="md-ellipsis">
      
        next_token_logprobs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.next_token_logprobs_sync" class="md-nav__link">
    <span class="md-ellipsis">
      
        next_token_logprobs_sync
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTransformer.next_token_logprobs_uncached" class="md-nav__link">
    <span class="md-ellipsis">
      
        next_token_logprobs_uncached
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#genlm.backend.load_model_by_name" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_model_by_name
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#genlm.backend.decode_vocab" class="md-nav__link">
    <span class="md-ellipsis">
      
        decode_vocab
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#genlm.backend.TokenCharacterTrie" class="md-nav__link">
    <span class="md-ellipsis">
      
        TokenCharacterTrie
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TokenCharacterTrie">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#genlm.backend.TokenCharacterTrie.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.TokenCharacterTrie.weight_sum" class="md-nav__link">
    <span class="md-ellipsis">
      
        weight_sum
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.TokenCharacterTrie.weight_max" class="md-nav__link">
    <span class="md-ellipsis">
      
        weight_max
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.TokenCharacterTrie.batch_weight_sum" class="md-nav__link">
    <span class="md-ellipsis">
      
        batch_weight_sum
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.TokenCharacterTrie.batch_weight_max" class="md-nav__link">
    <span class="md-ellipsis">
      
        batch_weight_max
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.TokenCharacterTrie.visualize" class="md-nav__link">
    <span class="md-ellipsis">
      
        visualize
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#genlm.backend.ParallelTokenCharacterTrie" class="md-nav__link">
    <span class="md-ellipsis">
      
        ParallelTokenCharacterTrie
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParallelTokenCharacterTrie">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#genlm.backend.ParallelTokenCharacterTrie.weight_sum" class="md-nav__link">
    <span class="md-ellipsis">
      
        weight_sum
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.ParallelTokenCharacterTrie.batch_weight_sum" class="md-nav__link">
    <span class="md-ellipsis">
      
        batch_weight_sum
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.ParallelTokenCharacterTrie.weight_max" class="md-nav__link">
    <span class="md-ellipsis">
      
        weight_max
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.ParallelTokenCharacterTrie.batch_weight_max" class="md-nav__link">
    <span class="md-ellipsis">
      
        batch_weight_max
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTokenCharacterTrie" class="md-nav__link">
    <span class="md-ellipsis">
      
        AsyncTokenCharacterTrie
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AsyncTokenCharacterTrie">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTokenCharacterTrie.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTokenCharacterTrie.from_vocab" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_vocab
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTokenCharacterTrie.weight_sum" class="md-nav__link">
    <span class="md-ellipsis">
      
        weight_sum
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTokenCharacterTrie.weight_max" class="md-nav__link">
    <span class="md-ellipsis">
      
        weight_max
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTokenCharacterTrie.start" class="md-nav__link">
    <span class="md-ellipsis">
      
        start
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTokenCharacterTrie.cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      
        cleanup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genlm.backend.AsyncTokenCharacterTrie.shutdown" class="md-nav__link">
    <span class="md-ellipsis">
      
        shutdown
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>backend</h1>

<div class="doc doc-object doc-module">



<a id="genlm.backend"></a>
    <div class="doc doc-contents first">










<div class="doc doc-children">







<div class="doc doc-object doc-class">



<h2 id="genlm.backend.AsyncVirtualLM" class="doc doc-heading">
            <code>AsyncVirtualLM</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AsyncLM (genlm.backend.llm.base.AsyncLM)" href="../llm/base/#genlm.backend.llm.base.AsyncLM">AsyncLM</a></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>genlm/backend/llm/vllm.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="k">class</span><span class="w"> </span><span class="nc">AsyncVirtualLM</span><span class="p">(</span><span class="n">AsyncLM</span><span class="p">):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="s2">&quot;detokenize&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="s2">&quot;ignore_eos&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="p">}</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">async_llm_engine</span><span class="p">,</span> <span class="n">cache_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cache_opts</span><span class="o">=</span><span class="p">{}):</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an `AsyncVirtualLM` instance.</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">            async_llm_engine (AsyncLLMEngine): The async vLLM engine instance.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">            cache_size (int, optional): Maximum size of the output cache. If 0, caching is disabled. Defaults to 0.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            cache_opts (dict, optional): Additional options to pass to the [`OutputCache`][genlm.backend.cache.OutputCache] constructor. Defaults to {}.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        Note:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">            The cache stores the log probabilities for previously seen token sequences to avoid redundant requests. KV caching is handled internally by the vLLM engine.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span> <span class="o">=</span> <span class="n">async_llm_engine</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_tokenizer</span><span class="p">()</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="n">OutputCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">cache_size</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="k">if</span> <span class="n">cache_size</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">log_stats</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">engine_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a `AsyncVirtualLM` instance from a model name.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">            model_name (str): Name of the model to load.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">            engine_opts (dict): Additional options to pass to the `AsyncLLMEngine`. The engine will be</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">                configured with prefix caching enabled and async output processing disabled by default.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">            **kwargs: Additional arguments passed to `AsyncVirtualLM` constructor.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">            (AsyncVirtualLM): An `AsyncVirtualLM` instance.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_VLLM</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="s2">&quot;vLLM not available. Install vLLM or use AsyncTransformer instead.&quot;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="k">if</span> <span class="n">engine_opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;enable_chunked_prefill&quot;</span> <span class="ow">in</span> <span class="n">engine_opts</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="k">if</span> <span class="n">engine_opts</span><span class="p">[</span><span class="s2">&quot;enable_chunked_prefill&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                    <span class="s2">&quot;Setting enable_chunked_prefill to True may interfere with AsyncVirtualLM&#39;s &quot;</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                    <span class="s2">&quot;custom sampling functionality.&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">engine_opts</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="s2">&quot;enable_prefix_caching&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="s2">&quot;disable_log_requests&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="s2">&quot;disable_async_output_proc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># This parameter forces vLLM to use v0, which is currently what we want to do.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="o">**</span><span class="p">(</span><span class="n">engine_opts</span> <span class="ow">or</span> <span class="p">{}),</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="p">}</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">engine</span> <span class="o">=</span> <span class="n">AsyncLLMEngine</span><span class="o">.</span><span class="n">from_engine_args</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">AsyncEngineArgs</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="o">**</span><span class="n">engine_opts</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">underlying_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">model_executor</span><span class="o">.</span><span class="n">driver_worker</span><span class="o">.</span><span class="n">model_runner</span><span class="o">.</span><span class="n">model</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token asynchronously with output caching.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">            token_ids_list (list[int]): A list of token IDs, representing a prompt to the language model.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">            result (torch.Tensor): Normalized log probability tensor.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">        Warning:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">            Do not use `asyncio.run(next_token_logprobs())` as it may interfere with vLLM&#39;s background loop.</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">            For synchronous usage, use the `next_token_logprobs_sync()` method instead.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token_logprobs</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_next_token_logprobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token asynchronously.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">            token_ids_list (list[int]): A list of token IDs, representing a prompt to the language model.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">            (torch.Tensor): Normalized log probability tensor.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">req_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span><span class="p">))</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="n">TokensPrompt</span><span class="p">(</span><span class="n">prompt_token_ids</span><span class="o">=</span><span class="n">token_ids</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">processor</span> <span class="o">=</span> <span class="n">PassThroughLogitsProcessor</span><span class="p">()</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">sampling_params</span><span class="o">=</span><span class="n">SamplingParams</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span> <span class="n">logits_processors</span><span class="o">=</span><span class="p">[</span><span class="n">processor</span><span class="p">]</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="p">),</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">request_id</span><span class="o">=</span><span class="n">req_id</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="p">):</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">log_probs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="s2">&quot;Log probs should be set by the logits processor.&quot;</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">log_probs</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token synchronously.</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">            token_ids_list (list[int]): A list of token IDs, representing a prompt to the language model.</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">            (torch.Tensor): Normalized log probability tensor.</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_next_token_logprobs_sync</span><span class="p">([</span><span class="n">token_ids</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batch_next_token_logprobs_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids_list</span><span class="p">):</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">        Request log probabilities of next tokens in a batch synchronously.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">            token_ids_list (list[list[int]]): A list of token ID lists, each representing a prompt to the language model.</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">            (torch.Tensor): A tensor of normalized log probability tensors, one for each prompt in the input list.</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="n">req_id2processors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="k">for</span> <span class="n">token_ids</span> <span class="ow">in</span> <span class="n">token_ids_list</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">req_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span><span class="p">))</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="n">req_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="n">processor</span> <span class="o">=</span> <span class="n">PassThroughLogitsProcessor</span><span class="p">()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="n">req_id2processors</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">processor</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="n">prompt</span><span class="o">=</span><span class="n">TokensPrompt</span><span class="p">(</span><span class="n">prompt_token_ids</span><span class="o">=</span><span class="n">token_ids</span><span class="p">),</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                <span class="n">params</span><span class="o">=</span><span class="n">SamplingParams</span><span class="p">(</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span> <span class="n">logits_processors</span><span class="o">=</span><span class="p">[</span><span class="n">processor</span><span class="p">]</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                <span class="p">),</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="n">request_id</span><span class="o">=</span><span class="n">req_id</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">has_unfinished_requests</span><span class="p">():</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                    <span class="k">assert</span> <span class="n">out</span><span class="o">.</span><span class="n">request_id</span> <span class="ow">in</span> <span class="n">req_id2processors</span><span class="p">,</span> <span class="p">(</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> not in requested IDs&quot;</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                    <span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="p">[</span><span class="n">req_id2processors</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">log_probs</span> <span class="k">for</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">]</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear output cache.&quot;&quot;&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up resources on deletion.&quot;&quot;&quot;</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_engine</span><span class="p">()</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up the vLLM engine and associated resources.&quot;&quot;&quot;</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="k">if</span> <span class="n">async_engine</span> <span class="o">:=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;async_llm_engine&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>            <span class="n">async_engine</span><span class="o">.</span><span class="n">shutdown_background_loop</span><span class="p">()</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="n">destroy_model_parallel</span><span class="p">()</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="n">destroy_distributed_environment</span><span class="p">()</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="n">prompt_token_ids</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="n">max_tokens</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="n">eos_token_ids</span><span class="p">,</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="p">):</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample from the language model.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">            prompt_token_ids (list[int]): The token IDs of the prompt.</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">            eos_token_ids (list[int]): The token IDs of the end-of-sequence tokens.</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">            temperature (float, optional): The temperature to use to rescale the logits. Defaults to 1.0.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">            max_tokens (int): The maximum number of tokens to generate.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">            seed (int, optional): The seed for the random number generator. Defaults to None.</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">            (list[int]): The sampled token IDs.</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="k">async</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">TokensPrompt</span><span class="p">(</span><span class="n">prompt_token_ids</span><span class="o">=</span><span class="n">prompt_token_ids</span><span class="p">),</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="n">sampling_params</span><span class="o">=</span><span class="n">SamplingParams</span><span class="p">(</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">byte_vocab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">eos_token_ids</span><span class="p">],</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="p">),</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="n">request_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span><span class="p">)),</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="p">):</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                    <span class="s2">&quot;Expected exactly one sequence group&quot;</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                <span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="n">token_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_ids</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="k">if</span> <span class="n">token_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">eos_token_ids</span><span class="p">:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                    <span class="n">token_ids</span> <span class="o">=</span> <span class="n">token_ids</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                <span class="k">return</span> <span class="n">token_ids</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncVirtualLM.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">async_llm_engine</span><span class="p">,</span> <span class="n">cache_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cache_opts</span><span class="o">=</span><span class="p">{})</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize an <code>AsyncVirtualLM</code> instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>async_llm_engine</code>
            </td>
            <td>
                  <code><span title="vllm.AsyncLLMEngine">AsyncLLMEngine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The async vLLM engine instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cache_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum size of the output cache. If 0, caching is disabled. Defaults to 0.</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cache_opts</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional options to pass to the <a class="autorefs autorefs-internal" href="../cache/#genlm.backend.cache.OutputCache"><code>OutputCache</code></a> constructor. Defaults to {}.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The cache stores the log probabilities for previously seen token sequences to avoid redundant requests. KV caching is handled internally by the vLLM engine.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/vllm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">async_llm_engine</span><span class="p">,</span> <span class="n">cache_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cache_opts</span><span class="o">=</span><span class="p">{}):</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize an `AsyncVirtualLM` instance.</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        async_llm_engine (AsyncLLMEngine): The async vLLM engine instance.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        cache_size (int, optional): Maximum size of the output cache. If 0, caching is disabled. Defaults to 0.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        cache_opts (dict, optional): Additional options to pass to the [`OutputCache`][genlm.backend.cache.OutputCache] constructor. Defaults to {}.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        The cache stores the log probabilities for previously seen token sequences to avoid redundant requests. KV caching is handled internally by the vLLM engine.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span> <span class="o">=</span> <span class="n">async_llm_engine</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_tokenizer</span><span class="p">()</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="n">OutputCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">cache_size</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_opts</span><span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="k">if</span> <span class="n">cache_size</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">log_stats</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncVirtualLM.from_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_name</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">engine_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Create a <code>AsyncVirtualLM</code> instance from a model name.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the model to load.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>engine_opts</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional options to pass to the <code>AsyncLLMEngine</code>. The engine will be
configured with prefix caching enabled and async output processing disabled by default.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to <code>AsyncVirtualLM</code> constructor.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="AsyncVirtualLM (genlm.backend.llm.vllm.AsyncVirtualLM)" href="../llm/vllm/#genlm.backend.llm.vllm.AsyncVirtualLM">AsyncVirtualLM</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An <code>AsyncVirtualLM</code> instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/vllm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="nd">@classmethod</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">engine_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a `AsyncVirtualLM` instance from a model name.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        model_name (str): Name of the model to load.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        engine_opts (dict): Additional options to pass to the `AsyncLLMEngine`. The engine will be</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">            configured with prefix caching enabled and async output processing disabled by default.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        **kwargs: Additional arguments passed to `AsyncVirtualLM` constructor.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        (AsyncVirtualLM): An `AsyncVirtualLM` instance.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_VLLM</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="s2">&quot;vLLM not available. Install vLLM or use AsyncTransformer instead.&quot;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="k">if</span> <span class="n">engine_opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;enable_chunked_prefill&quot;</span> <span class="ow">in</span> <span class="n">engine_opts</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="k">if</span> <span class="n">engine_opts</span><span class="p">[</span><span class="s2">&quot;enable_chunked_prefill&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="s2">&quot;Setting enable_chunked_prefill to True may interfere with AsyncVirtualLM&#39;s &quot;</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="s2">&quot;custom sampling functionality.&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="n">engine_opts</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="s2">&quot;enable_prefix_caching&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="s2">&quot;disable_log_requests&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="s2">&quot;disable_async_output_proc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># This parameter forces vLLM to use v0, which is currently what we want to do.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="o">**</span><span class="p">(</span><span class="n">engine_opts</span> <span class="ow">or</span> <span class="p">{}),</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="p">}</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">AsyncLLMEngine</span><span class="o">.</span><span class="n">from_engine_args</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">AsyncEngineArgs</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="o">**</span><span class="n">engine_opts</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncVirtualLM.next_token_logprobs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">next_token_logprobs</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Request log probabilities of next token asynchronously with output caching.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>token_ids_list</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of token IDs, representing a prompt to the language model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>result</code></td>            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Normalized log probability tensor.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="warning" open>
  <summary>Warning</summary>
  <p>Do not use <code>asyncio.run(next_token_logprobs())</code> as it may interfere with vLLM's background loop.
For synchronous usage, use the <code>next_token_logprobs_sync()</code> method instead.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/vllm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token asynchronously with output caching.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        token_ids_list (list[int]): A list of token IDs, representing a prompt to the language model.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">        result (torch.Tensor): Normalized log probability tensor.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">    Warning:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        Do not use `asyncio.run(next_token_logprobs())` as it may interfere with vLLM&#39;s background loop.</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">        For synchronous usage, use the `next_token_logprobs_sync()` method instead.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_token_logprobs</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncVirtualLM.next_token_logprobs_sync" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">next_token_logprobs_sync</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Request log probabilities of next token synchronously.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>token_ids_list</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of token IDs, representing a prompt to the language model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Normalized log probability tensor.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/vllm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token synchronously.</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a><span class="sd">        token_ids_list (list[int]): A list of token IDs, representing a prompt to the language model.</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">        (torch.Tensor): Normalized log probability tensor.</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_next_token_logprobs_sync</span><span class="p">([</span><span class="n">token_ids</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncVirtualLM.batch_next_token_logprobs_sync" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch_next_token_logprobs_sync</span><span class="p">(</span><span class="n">token_ids_list</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Request log probabilities of next tokens in a batch synchronously.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>token_ids_list</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of token ID lists, each representing a prompt to the language model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tensor of normalized log probability tensors, one for each prompt in the input list.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/vllm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="k">def</span><span class="w"> </span><span class="nf">batch_next_token_logprobs_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids_list</span><span class="p">):</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">    Request log probabilities of next tokens in a batch synchronously.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">        token_ids_list (list[list[int]]): A list of token ID lists, each representing a prompt to the language model.</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">        (torch.Tensor): A tensor of normalized log probability tensors, one for each prompt in the input list.</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">req_id2processors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="k">for</span> <span class="n">token_ids</span> <span class="ow">in</span> <span class="n">token_ids_list</span><span class="p">:</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="n">req_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span><span class="p">))</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="n">req_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req_id</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">processor</span> <span class="o">=</span> <span class="n">PassThroughLogitsProcessor</span><span class="p">()</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="n">req_id2processors</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">processor</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">add_request</span><span class="p">(</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">TokensPrompt</span><span class="p">(</span><span class="n">prompt_token_ids</span><span class="o">=</span><span class="n">token_ids</span><span class="p">),</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="n">params</span><span class="o">=</span><span class="n">SamplingParams</span><span class="p">(</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span> <span class="n">logits_processors</span><span class="o">=</span><span class="p">[</span><span class="n">processor</span><span class="p">]</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="p">),</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">request_id</span><span class="o">=</span><span class="n">req_id</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">has_unfinished_requests</span><span class="p">():</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                <span class="k">assert</span> <span class="n">out</span><span class="o">.</span><span class="n">request_id</span> <span class="ow">in</span> <span class="n">req_id2processors</span><span class="p">,</span> <span class="p">(</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out</span><span class="o">.</span><span class="n">request_id</span><span class="si">}</span><span class="s2"> not in requested IDs&quot;</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="p">[</span><span class="n">req_id2processors</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">log_probs</span> <span class="k">for</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="n">req_ids</span><span class="p">]</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncVirtualLM.clear_cache" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clear_cache</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Clear output cache.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/vllm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="k">def</span><span class="w"> </span><span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear output cache.&quot;&quot;&quot;</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncVirtualLM.__del__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__del__</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Clean up resources on deletion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/vllm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up resources on deletion.&quot;&quot;&quot;</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_engine</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncVirtualLM.sample" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sample</span><span class="p">(</span><span class="n">prompt_token_ids</span><span class="p">,</span> <span class="n">max_tokens</span><span class="p">,</span> <span class="n">eos_token_ids</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Sample from the language model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prompt_token_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token IDs of the prompt.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eos_token_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The token IDs of the end-of-sequence tokens.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>temperature</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The temperature to use to rescale the logits. Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_tokens</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of tokens to generate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The seed for the random number generator. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sampled token IDs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/vllm.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="n">prompt_token_ids</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>    <span class="n">max_tokens</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="n">eos_token_ids</span><span class="p">,</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="p">):</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample from the language model.</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        prompt_token_ids (list[int]): The token IDs of the prompt.</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        eos_token_ids (list[int]): The token IDs of the end-of-sequence tokens.</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        temperature (float, optional): The temperature to use to rescale the logits. Defaults to 1.0.</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">        max_tokens (int): The maximum number of tokens to generate.</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">        seed (int, optional): The seed for the random number generator. Defaults to None.</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">        (list[int]): The sampled token IDs.</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="k">async</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_engine</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">prompt</span><span class="o">=</span><span class="n">TokensPrompt</span><span class="p">(</span><span class="n">prompt_token_ids</span><span class="o">=</span><span class="n">prompt_token_ids</span><span class="p">),</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="n">sampling_params</span><span class="o">=</span><span class="n">SamplingParams</span><span class="p">(</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">byte_vocab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">eos_token_ids</span><span class="p">],</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="p">),</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="n">request_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_counter</span><span class="p">)),</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>    <span class="p">):</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                <span class="s2">&quot;Expected exactly one sequence group&quot;</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="n">token_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">token_ids</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="k">if</span> <span class="n">token_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">eos_token_ids</span><span class="p">:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                <span class="n">token_ids</span> <span class="o">=</span> <span class="n">token_ids</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="k">return</span> <span class="n">token_ids</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="genlm.backend.AsyncTransformer" class="doc doc-heading">
            <code>AsyncTransformer</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="AsyncLM (genlm.backend.llm.base.AsyncLM)" href="../llm/base/#genlm.backend.llm.base.AsyncLM">AsyncLM</a></code></p>



        <p>Asynchronous wrapper around a HuggingFace causal language model with caching support.</p>
<p>This class provides an asynchronous interface to HuggingFace language models with automatic batching
and caching (output and KV) for improved efficiency.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="k">class</span><span class="w"> </span><span class="nc">AsyncTransformer</span><span class="p">(</span><span class="n">AsyncLM</span><span class="p">):</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Asynchronous wrapper around a HuggingFace causal language model with caching support.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    This class provides an asynchronous interface to HuggingFace language models with automatic batching</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    and caching (output and KV) for improved efficiency.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">bitsandbytes_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hf_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an AsyncTransformer instance from a pretrained HuggingFace model.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">            model_id (str): Model identifier in HuggingFace&#39;s model hub.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">            bitsandbytes_opts (dict, optional): Additional configuration options for bitsandbytes quantization.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">            hf_opts (dict, optional): Additional configuration options for loading the HuggingFace model.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">                Defaults to None.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            **kwargs: Additional arguments passed to the `AsyncTransformer` constructor</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">            (AsyncTransformer): An initialized `AsyncTransformer` instance.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="k">if</span> <span class="n">bitsandbytes_opts</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">bnb_config</span> <span class="o">=</span> <span class="n">BitsAndBytesConfig</span><span class="p">(</span><span class="o">**</span><span class="n">bitsandbytes_opts</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="n">bnb_config</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">_hf_opts</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="s2">&quot;device_map&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="s2">&quot;torch_dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="p">}</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">if</span> <span class="n">hf_opts</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">_hf_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hf_opts</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">tok</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="n">mod</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">model_id</span><span class="p">,</span> <span class="n">quantization_config</span><span class="o">=</span><span class="n">bnb_config</span><span class="p">,</span> <span class="o">**</span><span class="n">_hf_opts</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an AsyncTransformer instance.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">            hf_model: A HuggingFace CausalLM model instance.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">            hf_tokenizer: A HuggingFace Tokenizer.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">            batch_size (int, optional): Maximum queries to process in one batch during auto-batching.</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">                Defaults to 20.</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">            timeout (float, optional): Seconds to wait since last query before processing current batch.</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">                Defaults to 0.02.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">hf_model</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">hf_tokenizer</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">hf_model</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">TokenTrie</span><span class="p">()</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="c1"># Queries to be batched. Each query is a sequence of tokens,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="c1"># and a Future to be called when the query is resolved.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the cache of log probabilities and key/value pairs.&quot;&quot;&quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">TokenTrie</span><span class="p">()</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_kv_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear any key and value vectors from the cache.&quot;&quot;&quot;</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear_kv_cache</span><span class="p">()</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_async_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear any pending language model queries from the queue. Use this method when an exception prevented an inference algorithm from executing</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        to completion.&quot;&quot;&quot;</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cache_kv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_tokens</span><span class="p">):</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cache the key and value vectors for a prompt. Future queries that have this prompt as a prefix will only run the LLM on new tokens.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">            prompt_tokens (list[int]): token ids for the prompt to cache.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">prompt_tokens</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">extend_cache</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">prompt_tokens</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">past_key_values</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batch_evaluate_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        Process a batch of queued language model queries.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        This method is called internally when the `batch_size` has been met or the `timeout` has expired.</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">queries</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">,</span> <span class="p">[]</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="k">return</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">query_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span>  <span class="c1"># XXX: cache based on past_len too?</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">query_groups</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="c1"># Use one representative query from each group</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">unique_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">query_groups</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="n">past_example</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">q</span><span class="o">.</span><span class="n">past</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span> <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">past</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">max_past_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">past_len</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">max_query_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">padding_token_id</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="p">[</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                <span class="n">q</span><span class="o">.</span><span class="n">prompt_padded</span><span class="p">(</span><span class="n">padding_token_id</span><span class="p">,</span> <span class="n">max_query_length</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="p">]</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">attn_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="p">[</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">q</span><span class="o">.</span><span class="n">attention_mask</span><span class="p">(</span><span class="n">max_past_length</span><span class="p">,</span> <span class="n">max_query_length</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="p">]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="n">posn_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">position_ids</span><span class="p">(</span><span class="n">max_past_length</span><span class="p">,</span> <span class="n">max_query_length</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span><span class="p">]</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="k">if</span> <span class="n">past_example</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="n">pasts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="p">[</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                    <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                        <span class="p">(</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                            <span class="o">*</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                                <span class="n">q</span><span class="o">.</span><span class="n">past_padded</span><span class="p">(</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                                    <span class="n">layer</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                                    <span class="n">j</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                                    <span class="n">max_past_length</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                                    <span class="n">past_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                                    <span class="n">past_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                                <span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                            <span class="p">),</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                        <span class="p">),</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                        <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                    <span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                <span class="p">]</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">past_example</span><span class="p">))</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="p">]</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="n">pasts</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">pasts</span> <span class="o">=</span> <span class="n">DynamicCache</span><span class="o">.</span><span class="n">from_legacy_cache</span><span class="p">(</span><span class="n">pasts</span><span class="p">)</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="n">input_ids</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="n">attention_mask</span><span class="o">=</span><span class="n">attn_masks</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>            <span class="n">position_ids</span><span class="o">=</span><span class="n">posn_ids</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="n">past_key_values</span><span class="o">=</span><span class="n">pasts</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="n">use_cache</span><span class="o">=</span><span class="n">pasts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">logits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_queries</span><span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_queries</span><span class="p">):</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="k">for</span> <span class="n">dup_query</span> <span class="ow">in</span> <span class="n">query_groups</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">prompt</span><span class="p">)]:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="n">dup_query</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">past</span><span class="p">):</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a query to be evaluated in the next batch.</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">        This method is called internally when a `next_token_logprobs` request is made.</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">            query (list[int]): Token IDs representing the query prompt</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">            future (asyncio.Future): Future to store the result in</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">            past (list[tuple[torch.Tensor]]|None): Past key/value states from previous evaluation,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">                or None if this is a new query</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">past</span><span class="p">))</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">batch_evaluate_queries</span><span class="p">()</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_evaluate_queries</span><span class="p">()</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="p">)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">walk_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Walk the cache tree to find the deepest node matching a sequence of tokens.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">            token_ids (list[int]): Sequence of token IDs to follow in the cache tree</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">            tuple:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">                - CacheNode: The deepest node in the cache tree that matches the token sequence</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">                - int: Number of tokens matched from the start of token_ids</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">                - list[tuple[torch.Tensor]]|None: Past key/value states from the deepest cached node,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">                    or None if no cached states were found</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">                - int: Base index indicating where the past states start in token_ids</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="c1"># Walk while tokens can be found</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="n">next_token_index</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="n">past</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="k">while</span> <span class="n">next_token_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                <span class="n">past</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="n">base</span> <span class="o">=</span> <span class="n">next_token_index</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">has_token</span><span class="p">(</span><span class="n">token_ids</span><span class="p">[</span><span class="n">next_token_index</span><span class="p">]):</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_token</span><span class="p">(</span><span class="n">token_ids</span><span class="p">[</span><span class="n">next_token_index</span><span class="p">])</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                <span class="n">next_token_index</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>                <span class="k">break</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="k">return</span> <span class="n">node</span><span class="p">,</span> <span class="n">next_token_index</span><span class="p">,</span> <span class="n">past</span><span class="p">,</span> <span class="n">base</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token. This version is asynchronous because it automatically batches concurrent requests; use with `await`.</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">            token_ids (list[int]): a list of token ids, representing a prompt to the language model.</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">            logprobs (torch.Tensor): a tensor of with the language model&#39;s log (normalized) probabilities for the next token following the prompt.</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">token_ids</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token ids must not be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="n">node</span><span class="p">,</span> <span class="n">next_token_index</span><span class="p">,</span> <span class="n">past</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk_cache</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="c1"># If we processed all tokens, then we&#39;re done.</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="k">if</span> <span class="n">next_token_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">logprobs</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="c1"># Create a future with the prompt</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_query</span><span class="p">(</span><span class="n">token_ids</span><span class="p">[</span><span class="n">base</span><span class="p">:],</span> <span class="n">future</span><span class="p">,</span> <span class="n">past</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="n">logits</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="c1"># Create new nodes</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">extend_cache</span><span class="p">(</span><span class="n">next_token_index</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">logprobs</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token. Not asynchronous, and does not support auto-batching.</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">            token_ids (list[int]): a list of token ids, representing a prompt to the language model.</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">            logprobs (torch.Tensor): a tensor with the language model&#39;s log (normalized) probabilities for the next token following the prompt.</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">token_ids</span><span class="p">:</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token ids must not be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="c1"># Walk while tokens can be found</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">node</span><span class="p">,</span> <span class="n">next_token_index</span><span class="p">,</span> <span class="n">past</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk_cache</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="k">if</span> <span class="n">next_token_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">logprobs</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">token_ids</span><span class="p">[</span><span class="n">base</span><span class="p">:]])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="n">past_key_values</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span><span class="p">,</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>            <span class="n">use_cache</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">extend_cache</span><span class="p">(</span><span class="n">next_token_index</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">logprobs</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs_uncached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token. No KV or output caching, and does not support auto-batching.</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">            token_ids (list[int]): a list of token ids, representing a prompt to the language model.</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">            logprobs (torch.Tensor): a tensor with the language model&#39;s log (normalized) probabilities for the next token following the prompt.</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">token_ids</span><span class="p">:</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token ids must not be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">token_ids</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>                <span class="n">past_key_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.from_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_name</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">bitsandbytes_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hf_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Create an AsyncTransformer instance from a pretrained HuggingFace model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model identifier in HuggingFace's model hub.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>bitsandbytes_opts</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional configuration options for bitsandbytes quantization.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hf_opts</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional configuration options for loading the HuggingFace model.
Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the <code>AsyncTransformer</code> constructor</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="AsyncTransformer (genlm.backend.llm.hf.AsyncTransformer)" href="../llm/hf/#genlm.backend.llm.hf.AsyncTransformer">AsyncTransformer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An initialized <code>AsyncTransformer</code> instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="nd">@classmethod</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">bitsandbytes_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hf_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an AsyncTransformer instance from a pretrained HuggingFace model.</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        model_id (str): Model identifier in HuggingFace&#39;s model hub.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        bitsandbytes_opts (dict, optional): Additional configuration options for bitsandbytes quantization.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        hf_opts (dict, optional): Additional configuration options for loading the HuggingFace model.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">            Defaults to None.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        **kwargs: Additional arguments passed to the `AsyncTransformer` constructor</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        (AsyncTransformer): An initialized `AsyncTransformer` instance.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">if</span> <span class="n">bitsandbytes_opts</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">bnb_config</span> <span class="o">=</span> <span class="n">BitsAndBytesConfig</span><span class="p">(</span><span class="o">**</span><span class="n">bitsandbytes_opts</span><span class="p">)</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">bnb_config</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">_hf_opts</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="s2">&quot;device_map&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="s2">&quot;torch_dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="p">}</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="k">if</span> <span class="n">hf_opts</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">_hf_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hf_opts</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">tok</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">mod</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">model_id</span><span class="p">,</span> <span class="n">quantization_config</span><span class="o">=</span><span class="n">bnb_config</span><span class="p">,</span> <span class="o">**</span><span class="n">_hf_opts</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">hf_model</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize an AsyncTransformer instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>hf_model</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A HuggingFace CausalLM model instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hf_tokenizer</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A HuggingFace Tokenizer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum queries to process in one batch during auto-batching.
Defaults to 20.</p>
              </div>
            </td>
            <td>
                  <code>20</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Seconds to wait since last query before processing current batch.
Defaults to 0.02.</p>
              </div>
            </td>
            <td>
                  <code>0.02</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize an AsyncTransformer instance.</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        hf_model: A HuggingFace CausalLM model instance.</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">        hf_tokenizer: A HuggingFace Tokenizer.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">        batch_size (int, optional): Maximum queries to process in one batch during auto-batching.</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">            Defaults to 20.</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        timeout (float, optional): Seconds to wait since last query before processing current batch.</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">            Defaults to 0.02.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">hf_model</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">hf_tokenizer</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">hf_model</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">TokenTrie</span><span class="p">()</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="c1"># Queries to be batched. Each query is a sequence of tokens,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="c1"># and a Future to be called when the query is resolved.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.clear_cache" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clear_cache</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Clear the cache of log probabilities and key/value pairs.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="k">def</span><span class="w"> </span><span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear the cache of log probabilities and key/value pairs.&quot;&quot;&quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">TokenTrie</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.clear_kv_cache" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clear_kv_cache</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Clear any key and value vectors from the cache.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="k">def</span><span class="w"> </span><span class="nf">clear_kv_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear any key and value vectors from the cache.&quot;&quot;&quot;</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear_kv_cache</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.reset_async_queries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reset_async_queries</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Clear any pending language model queries from the queue. Use this method when an exception prevented an inference algorithm from executing
to completion.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="k">def</span><span class="w"> </span><span class="nf">reset_async_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear any pending language model queries from the queue. Use this method when an exception prevented an inference algorithm from executing</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">    to completion.&quot;&quot;&quot;</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.cache_kv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cache_kv</span><span class="p">(</span><span class="n">prompt_tokens</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Cache the key and value vectors for a prompt. Future queries that have this prompt as a prefix will only run the LLM on new tokens.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prompt_tokens</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>token ids for the prompt to cache.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="k">def</span><span class="w"> </span><span class="nf">cache_kv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_tokens</span><span class="p">):</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Cache the key and value vectors for a prompt. Future queries that have this prompt as a prefix will only run the LLM on new tokens.</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        prompt_tokens (list[int]): token ids for the prompt to cache.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">prompt_tokens</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">extend_cache</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">prompt_tokens</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">past_key_values</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.batch_evaluate_queries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch_evaluate_queries</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Process a batch of queued language model queries.</p>
<p>This method is called internally when the <code>batch_size</code> has been met or the <code>timeout</code> has expired.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="k">def</span><span class="w"> </span><span class="nf">batch_evaluate_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    Process a batch of queued language model queries.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    This method is called internally when the `batch_size` has been met or the `timeout` has expired.</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">queries</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">,</span> <span class="p">[]</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="k">return</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">query_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span>  <span class="c1"># XXX: cache based on past_len too?</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">query_groups</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="c1"># Use one representative query from each group</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="n">unique_queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">query_groups</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="n">past_example</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">q</span><span class="o">.</span><span class="n">past</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span> <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">past</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">max_past_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">past_len</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="n">max_query_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">prompt</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="n">padding_token_id</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="p">[</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="n">q</span><span class="o">.</span><span class="n">prompt_padded</span><span class="p">(</span><span class="n">padding_token_id</span><span class="p">,</span> <span class="n">max_query_length</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="p">]</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="n">attn_masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="p">[</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">q</span><span class="o">.</span><span class="n">attention_mask</span><span class="p">(</span><span class="n">max_past_length</span><span class="p">,</span> <span class="n">max_query_length</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="p">]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="n">posn_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">position_ids</span><span class="p">(</span><span class="n">max_past_length</span><span class="p">,</span> <span class="n">max_query_length</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span><span class="p">]</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="k">if</span> <span class="n">past_example</span><span class="p">:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="n">pasts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="p">[</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                    <span class="p">(</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                        <span class="o">*</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                            <span class="n">q</span><span class="o">.</span><span class="n">past_padded</span><span class="p">(</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                                <span class="n">layer</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                                <span class="n">j</span><span class="p">,</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                                <span class="n">max_past_length</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                                <span class="n">past_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                                <span class="n">past_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                            <span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">unique_queries</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                        <span class="p">),</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                    <span class="p">),</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                    <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                <span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="p">]</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">past_example</span><span class="p">))</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="p">]</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">pasts</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="n">pasts</span> <span class="o">=</span> <span class="n">DynamicCache</span><span class="o">.</span><span class="n">from_legacy_cache</span><span class="p">(</span><span class="n">pasts</span><span class="p">)</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="n">input_ids</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="n">attention_mask</span><span class="o">=</span><span class="n">attn_masks</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="n">position_ids</span><span class="o">=</span><span class="n">posn_ids</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">past_key_values</span><span class="o">=</span><span class="n">pasts</span><span class="p">,</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">use_cache</span><span class="o">=</span><span class="n">pasts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">logits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_queries</span><span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_queries</span><span class="p">):</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="k">for</span> <span class="n">dup_query</span> <span class="ow">in</span> <span class="n">query_groups</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">prompt</span><span class="p">)]:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="n">dup_query</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.add_query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">past</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Add a query to be evaluated in the next batch.</p>
<p>This method is called internally when a <code>next_token_logprobs</code> request is made.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>query</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token IDs representing the query prompt</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>future</code>
            </td>
            <td>
                  <code><span title="asyncio.Future">Future</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Future to store the result in</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>past</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="tuple">tuple</span>[<span title="torch.Tensor">Tensor</span>]] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Past key/value states from previous evaluation,
or None if this is a new query</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="k">def</span><span class="w"> </span><span class="nf">add_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">past</span><span class="p">):</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a query to be evaluated in the next batch.</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">    This method is called internally when a `next_token_logprobs` request is made.</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        query (list[int]): Token IDs representing the query prompt</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        future (asyncio.Future): Future to store the result in</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">        past (list[tuple[torch.Tensor]]|None): Past key/value states from previous evaluation,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">            or None if this is a new query</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">past</span><span class="p">))</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_evaluate_queries</span><span class="p">()</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_evaluate_queries</span><span class="p">()</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.walk_cache" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">walk_cache</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Walk the cache tree to find the deepest node matching a sequence of tokens.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>token_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sequence of token IDs to follow in the cache tree</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>CacheNode: The deepest node in the cache tree that matches the token sequence</li>
<li>int: Number of tokens matched from the start of token_ids</li>
<li>list[tuple[torch.Tensor]]|None: Past key/value states from the deepest cached node,
    or None if no cached states were found</li>
<li>int: Base index indicating where the past states start in token_ids</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="k">def</span><span class="w"> </span><span class="nf">walk_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Walk the cache tree to find the deepest node matching a sequence of tokens.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        token_ids (list[int]): Sequence of token IDs to follow in the cache tree</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        tuple:</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="sd">            - CacheNode: The deepest node in the cache tree that matches the token sequence</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">            - int: Number of tokens matched from the start of token_ids</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">            - list[tuple[torch.Tensor]]|None: Past key/value states from the deepest cached node,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">                or None if no cached states were found</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a><span class="sd">            - int: Base index indicating where the past states start in token_ids</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="c1"># Walk while tokens can be found</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">next_token_index</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="n">past</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="k">while</span> <span class="n">next_token_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="n">past</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="n">base</span> <span class="o">=</span> <span class="n">next_token_index</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">has_token</span><span class="p">(</span><span class="n">token_ids</span><span class="p">[</span><span class="n">next_token_index</span><span class="p">]):</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_token</span><span class="p">(</span><span class="n">token_ids</span><span class="p">[</span><span class="n">next_token_index</span><span class="p">])</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">next_token_index</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="k">break</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>    <span class="k">return</span> <span class="n">node</span><span class="p">,</span> <span class="n">next_token_index</span><span class="p">,</span> <span class="n">past</span><span class="p">,</span> <span class="n">base</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.next_token_logprobs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">next_token_logprobs</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Request log probabilities of next token. This version is asynchronous because it automatically batches concurrent requests; use with <code>await</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>token_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a list of token ids, representing a prompt to the language model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>logprobs</code></td>            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a tensor of with the language model's log (normalized) probabilities for the next token following the prompt.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token. This version is asynchronous because it automatically batches concurrent requests; use with `await`.</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">        token_ids (list[int]): a list of token ids, representing a prompt to the language model.</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">        logprobs (torch.Tensor): a tensor of with the language model&#39;s log (normalized) probabilities for the next token following the prompt.</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">token_ids</span><span class="p">:</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token ids must not be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="n">node</span><span class="p">,</span> <span class="n">next_token_index</span><span class="p">,</span> <span class="n">past</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk_cache</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>    <span class="c1"># If we processed all tokens, then we&#39;re done.</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="k">if</span> <span class="n">next_token_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">logprobs</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="c1"># Create a future with the prompt</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">add_query</span><span class="p">(</span><span class="n">token_ids</span><span class="p">[</span><span class="n">base</span><span class="p">:],</span> <span class="n">future</span><span class="p">,</span> <span class="n">past</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="n">logits</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="c1"># Create new nodes</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>    <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">extend_cache</span><span class="p">(</span><span class="n">next_token_index</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">logprobs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.next_token_logprobs_sync" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">next_token_logprobs_sync</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Request log probabilities of next token. Not asynchronous, and does not support auto-batching.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>token_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a list of token ids, representing a prompt to the language model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>logprobs</code></td>            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a tensor with the language model's log (normalized) probabilities for the next token following the prompt.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token. Not asynchronous, and does not support auto-batching.</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">        token_ids (list[int]): a list of token ids, representing a prompt to the language model.</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">        logprobs (torch.Tensor): a tensor with the language model&#39;s log (normalized) probabilities for the next token following the prompt.</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">token_ids</span><span class="p">:</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token ids must not be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="c1"># Walk while tokens can be found</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>    <span class="n">node</span><span class="p">,</span> <span class="n">next_token_index</span><span class="p">,</span> <span class="n">past</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk_cache</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="k">if</span> <span class="n">next_token_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">logprobs</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">token_ids</span><span class="p">[</span><span class="n">base</span><span class="p">:]])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="n">past_key_values</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span><span class="p">,</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="n">use_cache</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">past_key_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>    <span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">extend_cache</span><span class="p">(</span><span class="n">next_token_index</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">logprobs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTransformer.next_token_logprobs_uncached" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">next_token_logprobs_uncached</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Request log probabilities of next token. No KV or output caching, and does not support auto-batching.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>token_ids</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a list of token ids, representing a prompt to the language model.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>logprobs</code></td>            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a tensor with the language model's log (normalized) probabilities for the next token following the prompt.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/hf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-368" name="__codelineno-0-368"></a><span class="k">def</span><span class="w"> </span><span class="nf">next_token_logprobs_uncached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request log probabilities of next token. No KV or output caching, and does not support auto-batching.</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">        token_ids (list[int]): a list of token ids, representing a prompt to the language model.</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a><span class="sd">        logprobs (torch.Tensor): a tensor with the language model&#39;s log (normalized) probabilities for the next token following the prompt.</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">token_ids</span><span class="p">:</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Token ids must not be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">token_ids</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="n">past_key_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="n">use_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-function">


<h2 id="genlm.backend.load_model_by_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_model_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">llm_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Load a language model by name.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hugging Face model name (e.g. "gpt2", "meta-llama/Llama-3.2-1B-Instruct")</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>backend</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Backend to use for inference. Can be "vllm", "hf" or "mock".
If None, defaults to "vllm" if CUDA is available, otherwise "hf".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>llm_opts</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional options to pass to the backend constructor.
See AsyncVirtualLM and AsyncTransformer documentation for details.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="AsyncLM (genlm.backend.llm.base.AsyncLM)" href="../llm/base/#genlm.backend.llm.base.AsyncLM">AsyncLM</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An asynchronous language model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an invalid backend is specified.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/llm/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_model_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">llm_opts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a language model by name.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        name (str): Hugging Face model name (e.g. &quot;gpt2&quot;, &quot;meta-llama/Llama-3.2-1B-Instruct&quot;)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        backend (str, optional): Backend to use for inference. Can be &quot;vllm&quot;, &quot;hf&quot; or &quot;mock&quot;.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">            If None, defaults to &quot;vllm&quot; if CUDA is available, otherwise &quot;hf&quot;.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        llm_opts (dict, optional): Additional options to pass to the backend constructor.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">            See AsyncVirtualLM and AsyncTransformer documentation for details.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        (AsyncLM): An asynchronous language model.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        (ValueError): If an invalid backend is specified.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;vllm&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;hf&quot;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="k">if</span> <span class="n">llm_opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">llm_opts</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;vllm&quot;</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">return</span> <span class="n">AsyncVirtualLM</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_opts</span><span class="p">)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;hf&quot;</span><span class="p">:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="k">return</span> <span class="n">AsyncTransformer</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_opts</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;mock&quot;</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="k">return</span> <span class="n">MockAsyncLM</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_opts</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;mlx&quot;</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="k">return</span> <span class="n">AsyncMlxLM</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">llm_opts</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid backend: </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h2 id="genlm.backend.decode_vocab" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">decode_vocab</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">byte2str_fallback</span><span class="o">=</span><span class="s1">&#39;tokenizer&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Convert tokenizer vocabulary into byte and string representations.</p>


<details class="warning" open>
  <summary>Warning</summary>
  <p>The byte representation is the canonical form. The string representation is provided for
convenience but may not decode properly for all tokens, especially those containing invalid UTF-8 sequences.</p>
</details>

<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tokenizer</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A Hugging Face tokenizer instance</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>byte2str_fallback</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strategy for converting invalid UTF-8 bytes to strings. Options:</p>
<ul>
<li>'tokenizer': Use tokenizer's <code>convert_ids_to_tokens</code> (default)</li>
<li>'latin1': Decode using latin1 encoding</li>
<li>'replace': Use Unicode replacement character ''</li>
</ul>
              </div>
            </td>
            <td>
                  <code>&#39;tokenizer&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(byte_vocab, str_vocab)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/tokenization/vocab.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">decode_vocab</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">byte2str_fallback</span><span class="o">=</span><span class="s2">&quot;tokenizer&quot;</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert tokenizer vocabulary into byte and string representations.</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    Warning:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">        The byte representation is the canonical form. The string representation is provided for</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        convenience but may not decode properly for all tokens, especially those containing invalid UTF-8 sequences.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        tokenizer: A Hugging Face tokenizer instance</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        byte2str_fallback (str): Strategy for converting invalid UTF-8 bytes to strings. Options:\n</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">            - &#39;tokenizer&#39;: Use tokenizer&#39;s `convert_ids_to_tokens` (default)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">            - &#39;latin1&#39;: Decode using latin1 encoding</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">            - &#39;replace&#39;: Use Unicode replacement character &#39;&#39;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        (tuple): (byte_vocab, str_vocab)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">if</span> <span class="n">byte2str_fallback</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;latin1&quot;</span><span class="p">,</span> <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown byte2str_fallback strategy: </span><span class="si">{</span><span class="n">byte2str_fallback</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="k">if</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">is_fast</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>            <span class="n">tokenizer</span><span class="o">.</span><span class="n">name_or_path</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="c1"># Try slow tokenizer.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="n">byte_vocab</span> <span class="o">=</span> <span class="n">get_byte_vocab</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="k">except</span> <span class="n">ByteVocabError</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="c1"># warnings.warn(&quot;Could not decode vocabulary from slow tokenizer. Trying using fast tokenizer.&quot;)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="c1"># Try fast tokenizer.</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">name_or_path</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="n">byte_vocab</span> <span class="o">=</span> <span class="n">get_byte_vocab</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">except</span> <span class="n">ByteVocabError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="sa">f</span><span class="s2">&quot;Could not decode byte representation of token vocabuary from tokenizer </span><span class="si">{</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">name_or_path</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">str_vocab</span> <span class="o">=</span> <span class="n">bytes_to_strs</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">byte_vocab</span><span class="p">,</span> <span class="n">byte2str_fallback</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="k">return</span> <span class="n">byte_vocab</span><span class="p">,</span> <span class="n">str_vocab</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="genlm.backend.TokenCharacterTrie" class="doc doc-heading">
            <code>TokenCharacterTrie</code>


</h2>


    <div class="doc doc-contents ">



        <p>A trie data structure for efficient token-to-character mapping.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>genlm/backend/trie/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-7">  7</a></span>
<span class="normal"><a href="#__codelineno-0-8">  8</a></span>
<span class="normal"><a href="#__codelineno-0-9">  9</a></span>
<span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">TokenCharacterTrie</span><span class="p">:</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A trie data structure for efficient token-to-character mapping.&quot;&quot;&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decode</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a `TokenCharacterTrie`.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">            decode (list): List representing the token vocabulary.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">                Each element of the list must be iterable.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decode</span> <span class="o">=</span> <span class="n">decode</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[{}]</span>  <span class="c1"># First node is root</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="k">for</span> <span class="n">token_id</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>            <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>                <span class="k">if</span> <span class="n">letter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">curr</span><span class="p">]:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">curr</span><span class="p">][</span><span class="n">letter</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>                <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">curr</span><span class="p">][</span><span class="n">letter</span><span class="p">]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">curr</span><span class="p">][</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="k">assert</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="p">,</span> <span class="p">(</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>                <span class="s2">&quot;Can&#39;t have duplicate words in vocabulary&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>            <span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">last</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token_id</span><span class="p">,</span> <span class="n">last</span><span class="p">))</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">leaf2word</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jump</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="c1"># Renumber the states of the trie so that they are named by a contiguous</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="c1"># range of integers and those integers respect the are topologically</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="c1"># ordering of the trie topology.  This improves the efficiency of the</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="c1"># updating the trie as it improves memory locality.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="n">ordering</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)):</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="n">ordering</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ordering</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">node2prefix</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">))):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="k">for</span> <span class="n">letter</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                <span class="k">if</span> <span class="n">letter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                    <span class="n">node2prefix</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">node2prefix</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                    <span class="n">node2prefix</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">node2prefix</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">letter</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node2prefix</span> <span class="o">=</span> <span class="n">node2prefix</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename all node indices in the trie using the provided mapping function.</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">            f (callable): Function that maps old node indices to new node indices</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">new_children</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="k">for</span> <span class="n">letter</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>                <span class="n">new_children</span><span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)][</span><span class="n">letter</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">new_children</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">leaf2word</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="p">])</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jump</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_children</span><span class="p">]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_alloc_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Allocate an array to store weight values for all nodes.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">            np.ndarray: Zero-initialized array for storing weight values</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_ws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Preprocess the weight vector to ensure it is a numpy array and on the correct device.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">            ws (torch.Tensor|np.ndarray): Token weights over the vocabulary of shape `(len(self.decode),)`</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">            (np.ndarray): Weight vector</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="k">if</span> <span class="n">ws</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">return</span> <span class="n">ws</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute weight sum for each node in the trie.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        For each node in the trie, this computes the sum of weights of all leaf nodes (tokens)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">        that are descendants of that node.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">            ws (torch.Tensor|np.ndarray): Token weights over the vocabulary of shape `(len(self.decode),)`</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">            (np.ndarray): Summed weights for each node in the trie.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">node_ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alloc_weights</span><span class="p">()</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">_update_trie_numba_sum</span><span class="p">(</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="n">node_ws</span><span class="o">=</span><span class="n">node_ws</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="n">ws</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="n">token_id_to_leaf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">jump</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="n">ordering</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="k">return</span> <span class="n">node_ws</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute weight max for each node in the trie.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">        For each node in the trie, this computes the maximum weight among all leaf nodes (tokens)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        that are descendants of that node.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">            ws (torch.Tensor|np.ndarray): Token weights over the vocabulary of shape `(len(self.decode),)`</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">            (np.ndarray): Weight max values for each node in the trie.</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">node_ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alloc_weights</span><span class="p">()</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">_update_trie_numba_max</span><span class="p">(</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">node_ws</span><span class="o">=</span><span class="n">node_ws</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">ws</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">token_id_to_leaf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">jump</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">ordering</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="k">return</span> <span class="n">node_ws</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batch_weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batched equivalent of `weight_sum`.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">            ws (list[torch.Tensor|np.ndarray]): Batch of token weights, each of shape `(len(self.decode),)`</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">            (np.ndarray): Batch of weight values of `len(ws)` for each node in the trie</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_sum</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span> <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">ws</span><span class="p">])</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batch_weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batched equivalent of `weight_max`.</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">            ws (list[torch.Tensor|np.ndarray]): Batch of token weights, each of shape `(len(self.decode),)`</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">            (np.ndarray): Batch of weight max values of `len(ws)` for each node in the trie</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_max</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span> <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">ws</span><span class="p">])</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a topological ordering of nodes beneath the given node.</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a><span class="sd">            node (int): Starting node index</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a><span class="sd">        Yields:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a><span class="sd">            int: Node indices in topological order</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="k">pass</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">a</span><span class="p">])</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="k">yield</span> <span class="n">node</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_order_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a complete topological ordering including all child nodes.</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">            node (int): Starting node index</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        Yields:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">            (int): Node indices in complete topological order</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">a</span><span class="p">])</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="k">yield</span> <span class="n">node</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualize the trie structure using Graphviz.</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">            ws (np.ndarray|None): Optional weight vector to display at each node.</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">                                Should be of length `len(self.children)`.</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">            (graphviz.Digraph): The generated graph object</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">graphviz</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="s2">&quot;Please install graphviz: pip install graphviz&quot;</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="p">)</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="sa">f</span><span class="s2">&quot;Weight vector length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match number of nodes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">dot</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Token Character Trie&quot;</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">dot</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;LR&quot;</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="c1"># Create a subgraph for the legend</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="k">with</span> <span class="n">dot</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cluster_legend&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">legend</span><span class="p">:</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="n">legend</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Legend&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;10&quot;</span><span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="n">legend</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;0.1&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;0.1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>            <span class="c1"># Example internal node</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="n">legend</span><span class="o">.</span><span class="n">node</span><span class="p">(</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                <span class="s2">&quot;legend_internal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                <span class="s2">&quot;Internal Node ID</span><span class="se">\n</span><span class="s2">&#39;Prefix&#39;</span><span class="se">\n</span><span class="s2">Weight (if provided)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="p">)</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="c1"># Example leaf node</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">legend</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">&quot;legend_leaf&quot;</span><span class="p">,</span> <span class="s2">&quot;Complete Token&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;doublecircle&quot;</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="n">legend</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                <span class="s2">&quot;legend_internal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                <span class="s2">&quot;legend_leaf&quot;</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Token item&quot;</span><span class="p">,</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;10&quot;</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="c1"># Align legend horizontally</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="n">legend</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;TB&quot;</span><span class="p">)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">legend</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="c1"># Add the main trie nodes and edges</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)):</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2prefix</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">ws</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="c1"># Color nodes based on mass if provided</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                <span class="n">max_ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                <span class="k">if</span> <span class="n">max_ws</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                    <span class="n">intensity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ws</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_ws</span><span class="p">))</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                    <span class="n">color</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">intensity</span><span class="si">:</span><span class="s2">02x</span><span class="si">}{</span><span class="mi">255</span><span class="si">:</span><span class="s2">02x</span><span class="si">}{</span><span class="n">intensity</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span>  <span class="c1"># white for zero mass</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span>  <span class="c1"># default white</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="k">if</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaf2word</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                    <span class="nb">str</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                    <span class="n">label</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                    <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;doublecircle&quot;</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                    <span class="n">style</span><span class="o">=</span><span class="s2">&quot;filled&quot;</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                    <span class="n">fillcolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                <span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                    <span class="nb">str</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="n">label</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;filled&quot;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="n">color</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                <span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">child_id</span> <span class="ow">in</span> <span class="n">children</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                <span class="k">if</span> <span class="n">char</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                    <span class="n">edge_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                    <span class="n">edge_label</span> <span class="o">=</span> <span class="s2">&quot;End-of-Token&quot;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                <span class="n">dot</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_id</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">edge_label</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="k">return</span> <span class="n">dot</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="genlm.backend.TokenCharacterTrie.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">decode</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize a <code>TokenCharacterTrie</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>decode</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List representing the token vocabulary.
Each element of the list must be iterable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decode</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a `TokenCharacterTrie`.</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">        decode (list): List representing the token vocabulary.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">            Each element of the list must be iterable.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">decode</span> <span class="o">=</span> <span class="n">decode</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[{}]</span>  <span class="c1"># First node is root</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="k">for</span> <span class="n">token_id</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>            <span class="k">if</span> <span class="n">letter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">curr</span><span class="p">]:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">curr</span><span class="p">][</span><span class="n">letter</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">curr</span><span class="p">][</span><span class="n">letter</span><span class="p">]</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">curr</span><span class="p">][</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="k">assert</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="p">,</span> <span class="p">(</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="s2">&quot;Can&#39;t have duplicate words in vocabulary&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">last</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token_id</span><span class="p">,</span> <span class="n">last</span><span class="p">))</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">leaf2word</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">word2leaf</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">jump</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">]</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="c1"># Renumber the states of the trie so that they are named by a contiguous</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="c1"># range of integers and those integers respect the are topologically</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="c1"># ordering of the trie topology.  This improves the efficiency of the</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="c1"># updating the trie as it improves memory locality.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">ordering</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)):</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">ordering</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ordering</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">node2prefix</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">))):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="k">for</span> <span class="n">letter</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="k">if</span> <span class="n">letter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                <span class="n">node2prefix</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">node2prefix</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                <span class="n">node2prefix</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">node2prefix</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">letter</span><span class="p">]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">node2prefix</span> <span class="o">=</span> <span class="n">node2prefix</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.TokenCharacterTrie.weight_sum" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weight_sum</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute weight sum for each node in the trie.</p>
<p>For each node in the trie, this computes the sum of weights of all leaf nodes (tokens)
that are descendants of that node.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token weights over the vocabulary of shape <code>(len(self.decode),)</code></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Summed weights for each node in the trie.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="k">def</span><span class="w"> </span><span class="nf">weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute weight sum for each node in the trie.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    For each node in the trie, this computes the sum of weights of all leaf nodes (tokens)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    that are descendants of that node.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        ws (torch.Tensor|np.ndarray): Token weights over the vocabulary of shape `(len(self.decode),)`</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        (np.ndarray): Summed weights for each node in the trie.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">node_ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alloc_weights</span><span class="p">()</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="n">_update_trie_numba_sum</span><span class="p">(</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">node_ws</span><span class="o">=</span><span class="n">node_ws</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">ws</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">token_id_to_leaf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="n">jump</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">ordering</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="k">return</span> <span class="n">node_ws</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.TokenCharacterTrie.weight_max" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weight_max</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute weight max for each node in the trie.</p>
<p>For each node in the trie, this computes the maximum weight among all leaf nodes (tokens)
that are descendants of that node.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span> | <span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token weights over the vocabulary of shape <code>(len(self.decode),)</code></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Weight max values for each node in the trie.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="k">def</span><span class="w"> </span><span class="nf">weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute weight max for each node in the trie.</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">    For each node in the trie, this computes the maximum weight among all leaf nodes (tokens)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">    that are descendants of that node.</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        ws (torch.Tensor|np.ndarray): Token weights over the vocabulary of shape `(len(self.decode),)`</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        (np.ndarray): Weight max values for each node in the trie.</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">node_ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alloc_weights</span><span class="p">()</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="n">_update_trie_numba_max</span><span class="p">(</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">node_ws</span><span class="o">=</span><span class="n">node_ws</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">ws</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">token_id_to_leaf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">jump</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">ordering</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ordering</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">return</span> <span class="n">node_ws</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.TokenCharacterTrie.batch_weight_sum" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch_weight_sum</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Batched equivalent of <code>weight_sum</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="torch.Tensor">Tensor</span> | <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch of token weights, each of shape <code>(len(self.decode),)</code></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch of weight values of <code>len(ws)</code> for each node in the trie</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="k">def</span><span class="w"> </span><span class="nf">batch_weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Batched equivalent of `weight_sum`.</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">        ws (list[torch.Tensor|np.ndarray]): Batch of token weights, each of shape `(len(self.decode),)`</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        (np.ndarray): Batch of weight values of `len(ws)` for each node in the trie</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_sum</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span> <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">ws</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.TokenCharacterTrie.batch_weight_max" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch_weight_max</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Batched equivalent of <code>weight_max</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="torch.Tensor">Tensor</span> | <span title="numpy.ndarray">ndarray</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch of token weights, each of shape <code>(len(self.decode),)</code></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch of weight max values of <code>len(ws)</code> for each node in the trie</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="k">def</span><span class="w"> </span><span class="nf">batch_weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Batched equivalent of `weight_max`.</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        ws (list[torch.Tensor|np.ndarray]): Batch of token weights, each of shape `(len(self.decode),)`</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">        (np.ndarray): Batch of weight max values of `len(ws)` for each node in the trie</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_max</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span> <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">ws</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.TokenCharacterTrie.visualize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">visualize</span><span class="p">(</span><span class="n">ws</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Visualize the trie structure using Graphviz.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional weight vector to display at each node.
                Should be of length <code>len(self.children)</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="graphviz.Digraph">Digraph</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The generated graph object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="k">def</span><span class="w"> </span><span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize the trie structure using Graphviz.</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        ws (np.ndarray|None): Optional weight vector to display at each node.</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">                            Should be of length `len(self.children)`.</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        (graphviz.Digraph): The generated graph object</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">graphviz</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="s2">&quot;Please install graphviz: pip install graphviz&quot;</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="p">)</span>  <span class="c1"># pragma: no cover</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="sa">f</span><span class="s2">&quot;Weight vector length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match number of nodes (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="n">dot</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Token Character Trie&quot;</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">dot</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;LR&quot;</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="c1"># Create a subgraph for the legend</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="k">with</span> <span class="n">dot</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cluster_legend&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">legend</span><span class="p">:</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="n">legend</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Legend&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;10&quot;</span><span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="n">legend</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;0.1&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;0.1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="c1"># Example internal node</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">legend</span><span class="o">.</span><span class="n">node</span><span class="p">(</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>            <span class="s2">&quot;legend_internal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="s2">&quot;Internal Node ID</span><span class="se">\n</span><span class="s2">&#39;Prefix&#39;</span><span class="se">\n</span><span class="s2">Weight (if provided)&quot;</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="p">)</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="c1"># Example leaf node</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="n">legend</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s2">&quot;legend_leaf&quot;</span><span class="p">,</span> <span class="s2">&quot;Complete Token&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;doublecircle&quot;</span><span class="p">)</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="n">legend</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="s2">&quot;legend_internal&quot;</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="s2">&quot;legend_leaf&quot;</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Token item&quot;</span><span class="p">,</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;10&quot;</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="c1"># Align legend horizontally</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">legend</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;TB&quot;</span><span class="p">)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">legend</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="c1"># Add the main trie nodes and edges</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)):</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2prefix</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">ws</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="c1"># Color nodes based on mass if provided</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">max_ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="k">if</span> <span class="n">max_ws</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="n">intensity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ws</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_ws</span><span class="p">))</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="n">color</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">intensity</span><span class="si">:</span><span class="s2">02x</span><span class="si">}{</span><span class="mi">255</span><span class="si">:</span><span class="s2">02x</span><span class="si">}{</span><span class="n">intensity</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span>  <span class="c1"># white for zero mass</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span>  <span class="c1"># default white</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="k">if</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaf2word</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                <span class="nb">str</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                <span class="n">label</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;doublecircle&quot;</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;filled&quot;</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                <span class="n">fillcolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="p">)</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                <span class="nb">str</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="n">label</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;filled&quot;</span><span class="p">,</span> <span class="n">fillcolor</span><span class="o">=</span><span class="n">color</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">child_id</span> <span class="ow">in</span> <span class="n">children</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="k">if</span> <span class="n">char</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                <span class="n">edge_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                <span class="n">edge_label</span> <span class="o">=</span> <span class="s2">&quot;End-of-Token&quot;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">dot</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">child_id</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">edge_label</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="k">return</span> <span class="n">dot</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="genlm.backend.ParallelTokenCharacterTrie" class="doc doc-heading">
            <code>ParallelTokenCharacterTrie</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="TokenCharacterTrie (genlm.backend.trie.base.TokenCharacterTrie)" href="../trie/base/#genlm.backend.trie.base.TokenCharacterTrie">TokenCharacterTrie</a></code></p>



        <p>A GPU-optimized version of <code>TokenCharacterTrie</code> that performs weight sum and max operations in parallel.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>genlm/backend/trie/parallel.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-5">  5</a></span>
<span class="normal"><a href="#__codelineno-0-6">  6</a></span>
<span class="normal"><a href="#__codelineno-0-7">  7</a></span>
<span class="normal"><a href="#__codelineno-0-8">  8</a></span>
<span class="normal"><a href="#__codelineno-0-9">  9</a></span>
<span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">ParallelTokenCharacterTrie</span><span class="p">(</span><span class="n">TokenCharacterTrie</span><span class="p">):</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A GPU-optimized version of `TokenCharacterTrie` that performs weight sum and max operations in parallel.&quot;&quot;&quot;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decode</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">decode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="s2">&quot;cuda&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid device: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">. Must be &#39;cpu&#39;, &#39;cuda&#39; or None&quot;</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_build_reachability_matrix</span><span class="p">()</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_parent_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds a mapping from each node to its parent node in the trie.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">            (dict): A dictionary where keys are child nodes and values are their parent nodes.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">parent</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jump</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>                <span class="n">parent</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="k">return</span> <span class="n">parent</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_reachability_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs a sparse reachability matrix for efficient weight propagation.</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        The matrix M is constructed such that M[i,j] = 1 if node j is either:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        - The leaf node i itself (self-connection)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        - An ancestor of leaf node i in the trie</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">leaf_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_id_to_leaf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_parent_map</span><span class="p">()</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leaf_indices</span><span class="p">):</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="c1"># self connections</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="n">current</span> <span class="o">=</span> <span class="n">node</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="k">while</span> <span class="n">current</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">:</span>  <span class="c1"># Walk up to root</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="n">ancestor</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">current</span><span class="p">]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="n">current</span> <span class="o">=</span> <span class="n">ancestor</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">src_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dst_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_coo_tensor</span><span class="p">(</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="n">indices</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">leaf_indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="p">)</span><span class="o">.</span><span class="n">to_sparse_csr</span><span class="p">()</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_preprocess_ws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_ws</span><span class="p">):</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">processed_batch_ws</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">batch_ws</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>                <span class="n">ws</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="k">elif</span> <span class="n">ws</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">or</span> <span class="n">ws</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>                <span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="k">assert</span> <span class="n">ws</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">),</span> <span class="p">[</span><span class="n">ws</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">)]</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="n">processed_batch_ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">processed_batch_ws</span><span class="p">)</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes weight sums given token weights.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        For each node in the trie, this computes the sum of weights of all leaf nodes (tokens)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        that are descendants of that node. This is efficiently implemented using sparse matrix multiplication</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        with a pre-computed reachability matrix.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">            ws (torch.Tensor): Token weights, shape (`len(self.decode)`,).</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            (numpy.ndarray): Summed weights for each node in the trie, shape (`len(self.decode)`,).</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">([</span><span class="n">ws</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batch_weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch version of `weight_sum`.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">            ws (torch.Tensor): Batch of token weights, shape (batch_size  `len(self.decode)`).</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">            numpy.ndarray: Summed weights for each node in the trie, shape (batch_size  num_nodes).</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">masses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">ws</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_ids</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">return</span> <span class="n">masses</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the max weights given the token weights.</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">        For each node in the trie, this computes the maximum weight among all leaf nodes (tokens)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        that are descendants of that node. This is efficiently implemented using parallel scatter_reduce</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        operations on GPU.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">            ws (torch.Tensor): Token weights, shape (`len(self.decode)`,).</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">            (numpy.ndarray): Maximum weights for each node in the trie, shape (`len(self.decode)`,).</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_weight_max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">([</span><span class="n">ws</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batch_weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch version of `weight_max`.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">            ws (torch.Tensor): Batch of token weights, shape (batch_size  `len(self.decode)`).</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">            (numpy.ndarray): Maximum weights for each node in the trie, shape (batch_size  num_nodes).</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="c1"># Get leaf weights</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="n">leaf_weights</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_ids</span><span class="p">]</span>  <span class="c1"># shape: (batch_size  num_leafs)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">leaf_weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="c1"># Use scatter_reduce to propagate maximum values in parallel</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="n">result</span><span class="o">.</span><span class="n">scatter_reduce_</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dst_indices</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="n">src</span><span class="o">=</span><span class="n">leaf_weights</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_indices</span><span class="p">],</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="n">reduce</span><span class="o">=</span><span class="s2">&quot;amax&quot;</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">include_self</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="genlm.backend.ParallelTokenCharacterTrie.weight_sum" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weight_sum</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Computes weight sums given token weights.</p>
<p>For each node in the trie, this computes the sum of weights of all leaf nodes (tokens)
that are descendants of that node. This is efficiently implemented using sparse matrix multiplication
with a pre-computed reachability matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token weights, shape (<code>len(self.decode)</code>,).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Summed weights for each node in the trie, shape (<code>len(self.decode)</code>,).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/parallel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span>
<span class="normal"><a href="#__codelineno-0-89">89</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="k">def</span><span class="w"> </span><span class="nf">weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes weight sums given token weights.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    For each node in the trie, this computes the sum of weights of all leaf nodes (tokens)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    that are descendants of that node. This is efficiently implemented using sparse matrix multiplication</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    with a pre-computed reachability matrix.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        ws (torch.Tensor): Token weights, shape (`len(self.decode)`,).</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        (numpy.ndarray): Summed weights for each node in the trie, shape (`len(self.decode)`,).</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">([</span><span class="n">ws</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.ParallelTokenCharacterTrie.batch_weight_sum" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch_weight_sum</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Batch version of <code>weight_sum</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch of token weights, shape (batch_size  <code>len(self.decode)</code>).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numpy.ndarray: Summed weights for each node in the trie, shape (batch_size  num_nodes).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/parallel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="k">def</span><span class="w"> </span><span class="nf">batch_weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch version of `weight_sum`.</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        ws (torch.Tensor): Batch of token weights, shape (batch_size  `len(self.decode)`).</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        numpy.ndarray: Summed weights for each node in the trie, shape (batch_size  num_nodes).</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">masses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">ws</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_ids</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="k">return</span> <span class="n">masses</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.ParallelTokenCharacterTrie.weight_max" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weight_max</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Computes the max weights given the token weights.</p>
<p>For each node in the trie, this computes the maximum weight among all leaf nodes (tokens)
that are descendants of that node. This is efficiently implemented using parallel scatter_reduce
operations on GPU.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token weights, shape (<code>len(self.decode)</code>,).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum weights for each node in the trie, shape (<code>len(self.decode)</code>,).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/parallel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="k">def</span><span class="w"> </span><span class="nf">weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the max weights given the token weights.</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="sd">    For each node in the trie, this computes the maximum weight among all leaf nodes (tokens)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">    that are descendants of that node. This is efficiently implemented using parallel scatter_reduce</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    operations on GPU.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><span class="sd">        ws (torch.Tensor): Token weights, shape (`len(self.decode)`,).</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="sd">        (numpy.ndarray): Maximum weights for each node in the trie, shape (`len(self.decode)`,).</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_weight_max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">([</span><span class="n">ws</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.ParallelTokenCharacterTrie.batch_weight_max" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch_weight_max</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Batch version of <code>weight_max</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch of token weights, shape (batch_size  <code>len(self.decode)</code>).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum weights for each node in the trie, shape (batch_size  num_nodes).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/parallel.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="k">def</span><span class="w"> </span><span class="nf">batch_weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch version of `weight_max`.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        ws (torch.Tensor): Batch of token weights, shape (batch_size  `len(self.decode)`).</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        (numpy.ndarray): Maximum weights for each node in the trie, shape (batch_size  num_nodes).</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_ws</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="c1"># Get leaf weights</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="n">leaf_weights</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_ids</span><span class="p">]</span>  <span class="c1"># shape: (batch_size  num_leafs)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">leaf_weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="c1"># Use scatter_reduce to propagate maximum values in parallel</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">)),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">result</span><span class="o">.</span><span class="n">scatter_reduce_</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dst_indices</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">src</span><span class="o">=</span><span class="n">leaf_weights</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_indices</span><span class="p">],</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">reduce</span><span class="o">=</span><span class="s2">&quot;amax&quot;</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">include_self</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="genlm.backend.AsyncTokenCharacterTrie" class="doc doc-heading">
            <code>AsyncTokenCharacterTrie</code>


</h2>


    <div class="doc doc-contents ">



        <p>An asynchronous wrapper for TokenCharacterTrie implementations that provides automatic request batching.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>genlm/backend/trie/async_impl.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">AsyncTokenCharacterTrie</span><span class="p">:</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;An asynchronous wrapper for TokenCharacterTrie implementations that provides automatic request batching.&quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trie</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an `AsyncTokenCharacterTrie`.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">            trie (TokenCharacterTrie|ParallelTokenCharacterTrie): The underlying `TokenCharacterTrie` or `ParallelTokenCharacterTrie` instance</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trie</span> <span class="o">=</span> <span class="n">trie</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_vocab</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an `AsyncTokenCharacterTrie` from a vocabulary.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">            vocab (list): The vocabulary over which the trie will be defined.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">            backend (str, optional): The trie implementation to use - either &#39;sequential&#39; or &#39;parallel&#39;.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">                    Defaults to &#39;parallel&#39; which uses GPU acceleration when available.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            **kwargs: Additional arguments passed to the trie constructor</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            (AsyncTokenCharacterTrie): The initialized asynchronous trie instance.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">trie</span> <span class="o">=</span> <span class="n">TokenCharacterTrie</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;parallel&quot;</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="n">trie</span> <span class="o">=</span> <span class="n">ParallelTokenCharacterTrie</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>                <span class="sa">f</span><span class="s2">&quot;Unknown backend: </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">. Must be one of [&#39;sequential&#39;, &#39;parallel&#39;]&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">trie</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_queue_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">request</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">op</span><span class="p">))</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="k">return</span> <span class="n">future</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Queue a `weight_sum` request. Multiple concurrent calls will be automatically batched</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        together.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">            ws (torch.Tensor): Token weights, shape (`len(self.trie.decode)`,).</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">            (np.ndarray): The calculated mass sums for the given distribution.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">future</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue_request</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Queue a `weight_max` request. Multiple concurrent calls will be automatically batched</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        together.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">            ws (torch.Tensor): Token weights, shape (`len(self.trie.decode)`,).</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            (np.ndarray): The calculated max weights for the given distribution.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">future</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue_request</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the background processing task if not already running.&quot;&quot;&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="p">)</span>  <span class="c1"># Create a new queue so that it is bound to the current event loop</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_background_loop</span><span class="p">())</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_do_weight_sums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_weights</span><span class="p">):</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trie</span><span class="o">.</span><span class="n">batch_weight_sum</span><span class="p">(</span><span class="n">batch_weights</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_do_weight_maxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_weights</span><span class="p">):</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trie</span><span class="o">.</span><span class="n">batch_weight_max</span><span class="p">(</span><span class="n">batch_weights</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_background_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Background task that processes queued weight sum and max requests.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        Continuously monitors the queue for new requests and processes them in batches</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        using the underlying trie implementation.</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">            Exception: If any error occurs during processing, it is propagated to all</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><span class="sd">                      pending futures in the current batch.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="n">op_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="n">request</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">op_groups</span><span class="p">[</span><span class="n">op</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">request</span><span class="p">,</span> <span class="n">future</span><span class="p">))</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                    <span class="n">request</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                    <span class="n">op_groups</span><span class="p">[</span><span class="n">op</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">request</span><span class="p">,</span> <span class="n">future</span><span class="p">))</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">op_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                    <span class="n">requests</span><span class="p">,</span> <span class="n">futures</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">group</span><span class="p">)</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span><span class="si">}</span><span class="s2"> sum requests&quot;</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_weight_sums</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span><span class="si">}</span><span class="s2"> max requests&quot;</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_weight_maxs</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown operation: </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                    <span class="k">for</span> <span class="n">future</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">futures</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                        <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">op_groups</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                            <span class="n">future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="k">raise</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async cleanup - preferred method&quot;&quot;&quot;</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="k">pass</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the background processing task and cleanup resources.&quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                <span class="c1"># Ignore runtime errors that might occur if event loop is closed</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                <span class="k">pass</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTokenCharacterTrie.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">trie</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize an <code>AsyncTokenCharacterTrie</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>trie</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TokenCharacterTrie (genlm.backend.trie.base.TokenCharacterTrie)" href="../trie/base/#genlm.backend.trie.base.TokenCharacterTrie">TokenCharacterTrie</a> | <a class="autorefs autorefs-internal" title="ParallelTokenCharacterTrie (genlm.backend.trie.parallel.ParallelTokenCharacterTrie)" href="../trie/parallel/#genlm.backend.trie.parallel.ParallelTokenCharacterTrie">ParallelTokenCharacterTrie</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The underlying <code>TokenCharacterTrie</code> or <code>ParallelTokenCharacterTrie</code> instance</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/async_impl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trie</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize an `AsyncTokenCharacterTrie`.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        trie (TokenCharacterTrie|ParallelTokenCharacterTrie): The underlying `TokenCharacterTrie` or `ParallelTokenCharacterTrie` instance</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">trie</span> <span class="o">=</span> <span class="n">trie</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTokenCharacterTrie.from_vocab" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_vocab</span><span class="p">(</span><span class="n">vocab</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;parallel&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Creates an <code>AsyncTokenCharacterTrie</code> from a vocabulary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>vocab</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vocabulary over which the trie will be defined.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>backend</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The trie implementation to use - either 'sequential' or 'parallel'.
    Defaults to 'parallel' which uses GPU acceleration when available.</p>
              </div>
            </td>
            <td>
                  <code>&#39;parallel&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to the trie constructor</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="AsyncTokenCharacterTrie (genlm.backend.trie.async_impl.AsyncTokenCharacterTrie)" href="../trie/async_impl/#genlm.backend.trie.async_impl.AsyncTokenCharacterTrie">AsyncTokenCharacterTrie</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The initialized asynchronous trie instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/async_impl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="nd">@classmethod</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_vocab</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates an `AsyncTokenCharacterTrie` from a vocabulary.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        vocab (list): The vocabulary over which the trie will be defined.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        backend (str, optional): The trie implementation to use - either &#39;sequential&#39; or &#39;parallel&#39;.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">                Defaults to &#39;parallel&#39; which uses GPU acceleration when available.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        **kwargs: Additional arguments passed to the trie constructor</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        (AsyncTokenCharacterTrie): The initialized asynchronous trie instance.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="n">trie</span> <span class="o">=</span> <span class="n">TokenCharacterTrie</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="k">elif</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;parallel&quot;</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">trie</span> <span class="o">=</span> <span class="n">ParallelTokenCharacterTrie</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="sa">f</span><span class="s2">&quot;Unknown backend: </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">. Must be one of [&#39;sequential&#39;, &#39;parallel&#39;]&quot;</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">trie</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTokenCharacterTrie.weight_sum" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weight_sum</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Queue a <code>weight_sum</code> request. Multiple concurrent calls will be automatically batched
together.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token weights, shape (<code>len(self.trie.decode)</code>,).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="np.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The calculated mass sums for the given distribution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/async_impl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">weight_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Queue a `weight_sum` request. Multiple concurrent calls will be automatically batched</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    together.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        ws (torch.Tensor): Token weights, shape (`len(self.trie.decode)`,).</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        (np.ndarray): The calculated mass sums for the given distribution.</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">future</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue_request</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTokenCharacterTrie.weight_max" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">weight_max</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Queue a <code>weight_max</code> request. Multiple concurrent calls will be automatically batched
together.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ws</code>
            </td>
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token weights, shape (<code>len(self.trie.decode)</code>,).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="np.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The calculated max weights for the given distribution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/async_impl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">weight_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Queue a `weight_max` request. Multiple concurrent calls will be automatically batched</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    together.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        ws (torch.Tensor): Token weights, shape (`len(self.trie.decode)`,).</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        (np.ndarray): The calculated max weights for the given distribution.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">future</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue_request</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTokenCharacterTrie.start" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Start the background processing task if not already running.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/async_impl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span>
<span class="normal"><a href="#__codelineno-0-84">84</a></span>
<span class="normal"><a href="#__codelineno-0-85">85</a></span>
<span class="normal"><a href="#__codelineno-0-86">86</a></span>
<span class="normal"><a href="#__codelineno-0-87">87</a></span>
<span class="normal"><a href="#__codelineno-0-88">88</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the background processing task if not already running.&quot;&quot;&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="p">)</span>  <span class="c1"># Create a new queue so that it is bound to the current event loop</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_background_loop</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTokenCharacterTrie.cleanup" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cleanup</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Async cleanup - preferred method</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/async_impl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Async cleanup - preferred method&quot;&quot;&quot;</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="k">pass</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>






<div class="doc doc-object doc-function">


<h3 id="genlm.backend.AsyncTokenCharacterTrie.shutdown" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">shutdown</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Stop the background processing task and cleanup resources.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>genlm/backend/trie/async_impl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Stop the background processing task and cleanup resources.&quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="c1"># Ignore runtime errors that might occur if event loop is closed</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="k">pass</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>




  </div>

    </div>

</div>




















  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>